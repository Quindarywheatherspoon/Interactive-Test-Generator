<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Interactive Test Generator</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial;
        line-height: 1.4;
        margin: 18px;
        background: #f7f8fb;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        padding: 18px;
        border-radius: 10px;
        box-shadow: 0 6px 20px rgba(20, 30, 60, 0.08);
      }
      textarea,
      input[type="text"],
      textarea.answerKey {
        width: 100%;
        padding: 10px;
        font-family: monospace;
        font-size: 13px;
        border-radius: 8px;
        border: 1px solid #d8dbe2;
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      button {
        padding: 8px 12px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
      }
      button.primary {
        background: #2b6df6;
        color: white;
      }
      button.ghost {
        background: transparent;
        border: 1px solid #cbd5e1;
      }
      .question {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #eef2ff;
        margin-bottom: 10px;
      }
      .qtext {
        font-weight: 600;
      }
      .feedback {
        margin-top: 8px;
      }
      .correct {
        color: green;
        font-weight: 700;
      }
      .wrong {
        color: #d9534f;
        font-weight: 700;
      }
      .small {
        font-size: 13px;
        color: #475569;
      }
      .notice {
        background: #fff7ed;
        border: 1px solid #ffedd5;
        padding: 8px;
        border-radius: 6px;
      }
      .controls {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      .meta {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-top: 8px;
        color: #475569;
      }
      label.k {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
      }

      /* Normal Mode Styles */
      .normal-mode-container {
        text-align: center;
        max-width: 800px;
        margin: 0 auto;
        min-height: 500px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        margin-bottom: 20px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: #2b6df6;
        transition: width 0.3s ease;
      }

      .question-counter {
        font-size: 14px;
        color: #64748b;
        margin-bottom: 10px;
      }

      .normal-question {
        font-size: 24px;
        font-weight: 700;
        margin: 30px 0;
        color: #1e293b;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .answer-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin: 30px 0;
        flex-grow: 1;
      }

      .answer-option {
        padding: 20px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 16px;
        font-weight: 500;
        background: white;
      }

      .answer-option:hover {
        border-color: #2b6df6;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(43, 109, 246, 0.15);
      }

      .answer-option.correct {
        background: #dcfce7;
        border-color: #16a34a;
        color: #15803d;
      }

      .answer-option.incorrect {
        background: #fef2f2;
        border-color: #dc2626;
        color: #dc2626;
      }

      .answer-option.disabled {
        pointer-events: none;
        opacity: 0.7;
      }

      .immediate-feedback {
        margin: 20px 0;
        padding: 15px;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 600;
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .immediate-feedback.correct {
        background: #dcfce7;
        color: #15803d;
      }

      .immediate-feedback.incorrect {
        background: #fef2f2;
        color: #dc2626;
      }

      .next-button-container {
        text-align: center;
        margin: 20px 0;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .next-button {
        background: #2b6df6;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
      }

      .next-button:hover {
        background: #1d4ed8;
      }

      .final-score {
        text-align: center;
        padding: 40px;
      }

      .final-score h2 {
        font-size: 32px;
        color: #1e293b;
        margin-bottom: 10px;
      }

      .score-details {
        font-size: 18px;
        color: #64748b;
        margin-bottom: 30px;
      }

      .mode-selector {
        margin-bottom: 15px;
      }

      select {
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid #d8dbe2;
        font-size: 14px;
        background: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Interactive Test Generator</h2>
      <p class="small">
        Use the format of the preset questions/answers as an example.<br />
        <strong>
          If you are on a HTML download, ignore these two boxes. Simply scroll
          down to take the test.
        </strong>
      </p>

      <label class="k">Questions (no inline answers)</label>
      <textarea id="input" rows="10">
1. What became the global currency of the Early Modern era?
A. Gold
B. Silver
C. Copper
D. Paper money

2. What labor system did Spain revive from the Incas to supply workers for silver mines?
A. Encomienda
B. Serfdom
C. Mita system
D. Chattel slavery
  </textarea
      >

      <label class="k" style="margin-top: 8px">Answer key (global)</label>
      <textarea id="answerKey" class="answerKey" rows="2">1:B, 2:C</textarea>

      <div class="mode-selector">
        <label class="k">Test Mode:</label>
        <select id="testMode">
          <option value="normal" selected>
            Normal Mode (One question at a time)
          </option>
          <option value="cram">Cram Mode (All questions at once)</option>
        </select>
      </div>

      <div class="controls" style="margin-top: 8px">
        <button class="primary" id="generate">Generate Test</button>
        <button class="ghost" id="clear">Clear</button>
        <button id="download">Download HTML</button>
      </div>

      <div id="noticeArea"></div>
      <div id="testArea" style="margin-top: 18px"></div>
      <div class="meta">
        <div id="score"></div>
        <div id="timing" class="small"></div>
      </div>
    </div>

    <!-- Test Scrambler link -->
    <a
      href="https://ylgx93.csb.app/ "
      target="_blank"
      style="
        position: fixed;
        bottom: 12px;
        right: 12px;
        background: #2b6df6;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        font-family: system-ui, Segoe UI, Roboto;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        z-index: 9999;
      "
    >
      Test Scrambler
    </a>

    <script>
      (function () {
        const input = document.getElementById("input");
        const answerKeyEl = document.getElementById("answerKey");
        const generate = document.getElementById("generate");
        const clear = document.getElementById("clear");
        const testArea = document.getElementById("testArea");
        const noticeArea = document.getElementById("noticeArea");
        const scoreEl = document.getElementById("score");
        const download = document.getElementById("download");
        const testMode = document.getElementById("testMode");

        function parseText(text) {
          const lines = text.replace(/\r/g, "").split("\n");
          const questions = [];
          let current = null;

          for (let line of lines) {
            line = line.trim();
            if (!line || line.startsWith("#")) continue;

            const qmatch = line.match(/^(\d+)[\.\)]\s*(.+)/);
            if (qmatch) {
              if (current) questions.push(current);
              current = {
                num: parseInt(qmatch[1], 10),
                text: qmatch[2].trim(),
                options: {},
              };
              continue;
            }

            const omatch = line.match(/^([A-D])\.\s*(.+)/i);
            if (omatch && current) {
              current.options[omatch[1].toUpperCase()] = omatch[2].trim();
              continue;
            }

            if (current) current.text += " " + line;
          }

          if (current) questions.push(current);
          return questions;
        }

        function applyGlobalAnswers(questions, keyText) {
          if (!keyText) return;
          let s = keyText.trim().replace(/^answers?\s*:\s*/i, "");
          const parts = s.split(/[;, \n]+/);
          parts.forEach((p) => {
            const m = p.match(/(\d+)\s*[:\)]?\s*([A-D])/i);
            if (m) {
              const n = parseInt(m[1], 10);
              const a = m[2].toUpperCase().trim();
              const q = questions.find((q) => q.num === n);
              if (q) q.answer = a;
            }
          });
        }

        function renderCramMode(questions) {
          testArea.innerHTML = "";
          if (!questions.length) {
            noticeArea.innerHTML =
              '<div class="notice">No questions found. Make sure each question starts with "1." and options with "A." etc. Do not include inline answers.</div>';
            return;
          }
          noticeArea.innerHTML = "";

          const form = document.createElement("form");
          form.id = "testForm";

          questions.forEach((q) => {
            const qdiv = document.createElement("div");
            qdiv.className = "question";
            qdiv.dataset.qnum = q.num;

            const qtxt = document.createElement("div");
            qtxt.className = "qtext";
            qtxt.textContent = q.num + ". " + q.text;
            qdiv.appendChild(qtxt);

            const optWrap = document.createElement("div");
            optWrap.style.marginTop = "8px";

            ["A", "B", "C", "D"].forEach((letter) => {
              const label = document.createElement("label");
              label.style.display = "block";
              label.style.cursor = "pointer";

              const input = document.createElement("input");
              input.type = "radio";
              input.name = "q" + q.num;
              input.value = letter;
              label.appendChild(input);

              const span = document.createElement("span");
              span.style.marginLeft = "8px";
              span.textContent = letter + ". " + (q.options[letter] || "");
              label.appendChild(span);

              optWrap.appendChild(label);
            });

            qdiv.appendChild(optWrap);

            const fb = document.createElement("div");
            fb.className = "feedback small";
            qdiv.appendChild(fb);

            form.appendChild(qdiv);
          });

          // buttons
          const checkBtn = document.createElement("button");
          checkBtn.type = "button";
          checkBtn.className = "primary";
          checkBtn.textContent = "Check Answers";

          const revealBtn = document.createElement("button");
          revealBtn.type = "button";
          revealBtn.className = "ghost";
          revealBtn.textContent = "Reveal Correct Answers";

          const resetBtn = document.createElement("button");
          resetBtn.type = "button";
          resetBtn.textContent = "Reset";

          const controls = document.createElement("div");
          controls.className = "controls";
          controls.appendChild(checkBtn);
          controls.appendChild(revealBtn);
          controls.appendChild(resetBtn);
          form.appendChild(controls);

          testArea.appendChild(form);

          checkBtn.addEventListener("click", () => {
            let correctCount = 0;
            let graded = 0;

            questions.forEach((q) => {
              const radios = form.querySelectorAll('[name="q' + q.num + '"]');
              let selected = null;
              radios.forEach((r) => {
                if (r.checked) selected = r.value;
              });

              const fb = form.querySelector(
                '.question[data-qnum="' + q.num + '"] .feedback'
              );
              fb.innerHTML = "";

              if (!q.answer) {
                fb.innerHTML =
                  '<span class="small">No answer key provided — cannot grade automatically.</span>';
                if (selected)
                  fb.innerHTML +=
                    " Your answer: <strong>" + selected + "</strong>";
              } else {
                graded++;
                if (selected && selected.trim() === q.answer.trim()) {
                  correctCount++;
                  fb.innerHTML =
                    '<span class="correct">Correct ✓</span> — Your answer: ' +
                    selected;
                } else {
                  fb.innerHTML =
                    '<span class="wrong">Incorrect ✗</span> — Your answer: ' +
                    (selected || "—") +
                    " — Correct: <strong>" +
                    q.answer +
                    "</strong>";
                }
              }
            });

            if (graded > 0)
              scoreEl.textContent =
                "Score: " +
                correctCount +
                " / " +
                graded +
                " (graded questions)";
            else
              scoreEl.textContent =
                "No graded questions (no answer key provided).";
          });

          revealBtn.addEventListener("click", () => {
            questions.forEach((q) => {
              const fb = form.querySelector(
                '.question[data-qnum="' + q.num + '"] .feedback'
              );
              fb.innerHTML = q.answer
                ? '<span class="small">Correct answer: <strong>' +
                  q.answer +
                  "</strong></span>"
                : '<span class="small">No answer key for this question.</span>';
            });
          });

          resetBtn.addEventListener("click", () => {
            form.reset();
            scoreEl.textContent = "";
            form
              .querySelectorAll(".feedback")
              .forEach((f) => (f.innerHTML = ""));
          });
        }

        function renderNormalMode(questions) {
          testArea.innerHTML = "";
          if (!questions.length) {
            noticeArea.innerHTML =
              '<div class="notice">No questions found. Make sure each question starts with "1." and options with "A." etc. Do not include inline answers.</div>';
            return;
          }
          noticeArea.innerHTML = "";

          const container = document.createElement("div");
          container.className = "normal-mode-container";

          // Progress bar
          const progressBar = document.createElement("div");
          progressBar.className = "progress-bar";
          const progressFill = document.createElement("div");
          progressFill.className = "progress-fill";
          progressBar.appendChild(progressFill);
          container.appendChild(progressBar);

          // Question counter
          const questionCounter = document.createElement("div");
          questionCounter.className = "question-counter";
          container.appendChild(questionCounter);

          // Question display
          const questionDisplay = document.createElement("div");
          questionDisplay.className = "normal-question";
          container.appendChild(questionDisplay);

          // Answer options
          const answerOptions = document.createElement("div");
          answerOptions.className = "answer-options";
          container.appendChild(answerOptions);

          // Feedback display
          const feedbackDisplay = document.createElement("div");
          feedbackDisplay.className = "immediate-feedback";
          container.appendChild(feedbackDisplay);

          // Next button container
          const nextButtonContainer = document.createElement("div");
          nextButtonContainer.className = "next-button-container";

          // Next button
          const nextButton = document.createElement("button");
          nextButton.className = "next-button";
          nextButton.textContent = "Next Question";
          nextButton.style.display = "none";
          nextButtonContainer.appendChild(nextButton);
          container.appendChild(nextButtonContainer);

          testArea.appendChild(container);

          let currentQuestionIndex = 0;
          let correctAnswers = 0;
          let answeredQuestions = 0;

          function displayQuestion(index) {
            const q = questions[index];
            questionCounter.textContent = `Question ${index + 1} of ${
              questions.length
            }`;
            questionDisplay.textContent = q.text;
            progressFill.style.width = `${
              ((index + 1) / questions.length) * 100
            }%`;

            answerOptions.innerHTML = "";
            feedbackDisplay.innerHTML = "";
            feedbackDisplay.className = "immediate-feedback";
            nextButton.style.display = "none";

            ["A", "B", "C", "D"].forEach((letter) => {
              if (q.options[letter]) {
                const option = document.createElement("button");
                option.className = "answer-option";
                option.textContent = `${letter}. ${q.options[letter]}`;
                option.dataset.answer = letter;

                option.addEventListener("click", () => {
                  answeredQuestions++;

                  // Disable all options
                  answerOptions
                    .querySelectorAll(".answer-option")
                    .forEach((opt) => {
                      opt.classList.add("disabled");
                    });

                  if (q.answer && letter === q.answer) {
                    // Correct answer
                    option.classList.add("correct");
                    feedbackDisplay.textContent = "✓ Correct!";
                    feedbackDisplay.classList.add("correct");
                    correctAnswers++;
                  } else {
                    // Incorrect answer
                    option.classList.add("incorrect");
                    feedbackDisplay.textContent = `✗ Incorrect! The correct answer is ${q.answer}.`;
                    feedbackDisplay.classList.add("incorrect");

                    // Show correct answer
                    if (q.answer) {
                      const correctOption = answerOptions.querySelector(
                        `[data-answer="${q.answer}"]`
                      );
                      if (correctOption) correctOption.classList.add("correct");
                    }
                  }

                  nextButton.style.display = "inline-block";

                  // Scroll to make sure next button is visible
                  nextButtonContainer.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                  });
                });

                answerOptions.appendChild(option);
              }
            });
          }

          nextButton.addEventListener("click", () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
              displayQuestion(currentQuestionIndex);
            } else {
              // Show final score
              container.innerHTML = `
                <div class="final-score">
                  <h2>Test Complete!</h2>
                  <div class="score-details">
                    You answered ${correctAnswers} out of ${
                questions.length
              } questions correctly.
                  </div>
                  <div style="font-size: 48px; margin: 20px 0;">
                    ${Math.round((correctAnswers / questions.length) * 100)}%
                  </div>
                  <button class="primary" onclick="location.reload()">Take Test Again</button>
                </div>
              `;
              scoreEl.textContent = `Final Score: ${correctAnswers} / ${questions.length}`;
            }
          });

          // Display first question
          displayQuestion(0);
        }

        generate.addEventListener("click", () => {
          const questions = parseText(input.value);
          applyGlobalAnswers(questions, answerKeyEl.value);

          if (testMode.value === "normal") {
            renderNormalMode(questions);
          } else {
            renderCramMode(questions);
          }
        });

        clear.addEventListener("click", () => {
          input.value = "";
          answerKeyEl.value = "";
          testArea.innerHTML = "";
          noticeArea.innerHTML = "";
          scoreEl.textContent = "";
        });

        download.addEventListener("click", () => {
          document.getElementById("input").textContent = input.value;
          document.getElementById("answerKey").textContent = answerKeyEl.value;

          const blob = new Blob([document.documentElement.outerHTML], {
            type: "text/html",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "interactive_test.html";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });
        if (!window.opener) generate.click();
      })();
    </script>
  </body>
</html>
